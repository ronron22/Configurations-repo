#!/bin/bash

# script de surveillance de la réplication Postgresql Streaming
# se fait via un test sur le nom du processus s'occupant du streaming.

# Wed Apr 10 11:34:21 CEST 2013 kilian v0.1

ERRCODE=2
TYPE=master
PROCNAME=postgres

if [ ! -z "$1" ]; then
	TYPE=$1
fi
case $TYPE in
	master)
		# postgres: wal sender process replic 172.16.45.8(36525) streaming 11/2D7A5D40
		PATTERN='postgres: wal sender process.*streaming'
		EXTRACT_INFO='s/.*process //'
		;;
	slave)
		# postgres: wal receiver process   streaming 11/2D7ACC78
		PATTERN='postgres: wal receiver process[\t\ ]+streaming'
		EXTRACT_INFO='s/.*streaming //'
		;;
	*)
		echo "Usage: $0 <master|slave>"
		exit -1
esac

LIGNE=$( pgrep $PROCNAME | xargs ps -c | grep -E "$PATTERN" )
if [ $? -ne 0 ]; then
	ERRCODE=2
	echo "CRITICAL - réplication cassé"
else
	ERRCODE=0
	INFO=$( echo $LIGNE | sed -e "$EXTRACT_INFO" )
	echo "OK - $INFO"
fi
exit $ERRCODE

