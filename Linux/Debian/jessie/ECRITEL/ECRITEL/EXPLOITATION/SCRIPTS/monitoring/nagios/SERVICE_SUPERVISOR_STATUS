#!/usr/bin/env bash

shopt -s extglob

PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
\unalias -a

NAME="supervisor"

#Â liste noir de service a ne pas surveiller separer par |
WBL="RUNNING|crashmail"

_NAGIOS_STATUS_OK=0
_NAGIOS_STATUS_WARNING=1
_NAGIOS_STATUS_CRITICAL=2
_NAGIOS_STATUS_UNKNOWN=3

for MYPROG in supervisorctl pgrep wc ; do
        if ! type -ap $MYPROG 1> /dev/null ; then
                echo "WARNING : impossible de trouver $MYPROG" ;
                exit $_NAGIOS_STATUS_UNKNOWN
        fi
done

supervisor_status_funct() {
	if ! pgrep $NAME 1>/dev/null ; then
			echo "Unable to get the $NAME PID" ;
			exit $_NAGIOS_STATUS_CRITICAL
	else
		if ! supervisorctl status ; then
			echo "Unable to get the $NAME status" ;
		fi
	fi
}

#count_wbl_funct() {
#	echo "$WBL" | wc -w
#
#}

supervisor_status_funct|{ while read LINE ; do 
	if ! [[ "$LINE" =~  $WBL ]] ; then 
		((COUNTER_NOK++))
	else
		((COUNTER_OK++))
	fi ;
done

NB_OK=${COUNTER_OK:-0}
NB_NOK=${COUNTER_NOK:-0}
NB_TOTAL=$((($NB_NOK+$NB_OK)))

if (($NB_NOK>0)) ; then
	echo "CRITICAL: $NB_NOK service(s) sur $NB_TOTAL est en anomalie, merci d'intervenir" ;
	exit $_NAGIOS_STATUS_CRITICAL
else
	if (($NB_NOK==0)) ; then
		echo "OK : $NB_OK service(s) sur $NB_TOTAL d'actif(s)" ;
		exit $_NAGIOS_STATUS_OK
	fi
fi	

# catch if no match	
exit $_NAGIOS_STATUS_UNKNOWN
}
